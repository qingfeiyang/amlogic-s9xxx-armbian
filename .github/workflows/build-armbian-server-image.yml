name: Build Armbian for S905L3B (Fix Exit 43)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: 检查代码
      uses: actions/checkout@v4

    - name: 克隆 Armbian 仓库
      run: |
        git clone --depth=1 https://github.com/armbian/build.git

    - name: 安装依赖（极简稳定版）
      run: |
        set -x
        sudo apt clean
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android  # 释放20GB+空间
        df -h
        sudo apt update -y
        sudo apt install -y build-essential git debootstrap qemu-user-static \
          bc flex bison libssl-dev u-boot-tools rsync
        set +x

    - name: 编译 Armbian（强制日志+资源监控）
      run: |
        # 关键：创建编译日志文件，监控内存/磁盘并写入日志
        COMPILE_LOG="/tmp/armbian-compile.log"
        touch $COMPILE_LOG
        # 后台实时监控资源使用（每30秒记录一次）
        (while true; do
          echo "=== 资源监控 $(date) ===" >> $COMPILE_LOG
          free -m >> $COMPILE_LOG
          df -h >> $COMPILE_LOG
          sleep 30
        done) &
        MONITOR_PID=$!  # 记录监控进程ID

        # 执行编译，强制输出所有日志到文件
        echo "=== 开始编译 $(date) ===" >> $COMPILE_LOG
        cd build
        sudo ./compile.sh \
          BOARD=s905l3 \
          BRANCH=legacy \  # 切换到更稳定的旧分支（减少兼容性问题）
          RELEASE=bullseye \
          KERNEL_ONLY=no \
          BUILD_DESKTOP=no \
          CLEAN_LEVEL=images \
          USE_TORRENT=no \
          KERNELBRANCH="tag:v5.15.137" \  # 5.15内核对S905L3更稳定
          EXTRA_ARGUMENTS="USB_INIT=yes" \
          --debug 2>&1 >> $COMPILE_LOG  # 开启debug模式，捕获详细日志

        # 编译结束后终止监控进程
        kill $MONITOR_PID
        echo "=== 编译结束 $(date) ===" >> $COMPILE_LOG

    - name: 上传编译日志（无论成败）
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: compile-logs
        path: /tmp/armbian-compile.log
        retention-days: 7

    - name: 上传镜像（成功时）
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: armbian-s905l3b-usb
        path: build/output/images/*.img.xz
        retention-days: 30
