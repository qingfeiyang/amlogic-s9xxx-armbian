name: Build Armbian for S905L3B (Force Logs)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: 检查代码
      uses: actions/checkout@v4

    - name: 克隆 Armbian 仓库
      run: |
        git clone --depth=1 https://github.com/armbian/build.git

    - name: 安装依赖（强制日志输出，极简步骤）
      run: |
        # 关键：开启命令跟踪（每步命令都打印），并强制输出到 GitHub 日志流
        set -x
        # 确保日志能被 GitHub 捕获（即使中间失败）
        echo "=== 系统状态检查 ==="
        df -h  # 检查磁盘空间（exit code 1 常见原因：磁盘满）
        free -m  # 检查内存
        id  # 检查当前用户权限

        echo "=== 清理系统缓存 ==="
        sudo apt clean
        sudo rm -rf /var/cache/apt/archives/* /var/lib/apt/lists/* || true  # 允许失败

        echo "=== 更换为清华 apt 源（确保网络稳定） ==="
        sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
        echo "deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy main restricted universe multiverse
        deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-updates main restricted universe multiverse
        deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-backports main restricted universe multiverse
        deb https://mirrors.tuna.tsinghua.edu.cn/ubuntu/ jammy-security main restricted universe multiverse" | sudo tee /etc/apt/sources.list

        echo "=== 更新源（单独步骤，失败立即报错） ==="
        sudo apt update -y || { echo "❌ apt update 失败"; exit 1; }

        echo "=== 安装核心依赖（分最小集，逐个检查） ==="
        # 只安装必须依赖，减少失败点
        sudo apt install -y build-essential || { echo "❌ 缺少基础编译工具"; exit 1; }
        sudo apt install -y git wget || { echo "❌ 缺少 git/wget"; exit 1; }
        sudo apt install -y debootstrap qemu-user-static || { echo "❌ 缺少系统构建工具"; exit 1; }
        sudo apt install -y linux-headers-generic || { echo "❌ 缺少内核头文件（非致命，继续）"; }

        echo "=== 依赖安装成功 ==="
        set +x  # 关闭命令跟踪

    - name: 编译 Armbian 镜像
      run: |
        cd build
        sudo ./compile.sh \
          BOARD=s905l3 \
          BRANCH=current \
          RELEASE=bullseye \
          KERNEL_ONLY=no \
          BUILD_DESKTOP=no \
          CLEAN_LEVEL=images \
          USE_TORRENT=no \
          EXTRA_ARGUMENTS="USB_INIT=yes"

    - name: 上传镜像
      uses: actions/upload-artifact@v4
      with:
        name: armbian-s905l3b-usb
        path: build/output/images/*.img.xz
        retention-days: 30
