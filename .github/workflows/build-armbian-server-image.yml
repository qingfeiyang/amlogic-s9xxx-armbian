name: Build Armbian for S905L3B

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      BOARD: "s905l3"
      RELEASE: "bullseye"
      KERNEL_VERSION: "6.1.147"
      DTB_URL: "https://raw.githubusercontent.com/ophub/amlogic-dtb/meson-gxl/meson-gxlx2-p295.dtb"
      DTB_FILE: "meson-gxlx2-p295.dtb"
      OUTPUT_DIR: "${{ github.workspace }}/build/output/images"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup build environment
      run: |
        sudo apt update -y
        sudo apt install -y \
          build-essential git libncurses5-dev libssl-dev \
          bc flex bison libelf-dev liblz4-tool whiptail \
          parted kmod debootstrap qemu-user-static \
          chroot dosfstools rsync u-boot-tools curl \
          wget xz-utils cpio \
          python3-dev python3-pip python3-setuptools \
          libpython3-dev libffi-dev libssl-dev \
          binfmt-support qemu-user-static \
          systemd-container u-boot-tools \
          device-tree-compiler

        # 验证基础工具
        if ! command -v dtc &> /dev/null; then
          echo "❌ dtc未安装"
          exit 1
        fi

    - name: Download and prepare DTB
      run: |
        mkdir -p userpatches/dtb
        wget -O "userpatches/dtb/${{ env.DTB_FILE }}" "${{ env.DTB_URL }}"
        
        # 验证DTB文件
        if ! file "userpatches/dtb/${{ env.DTB_FILE }}" | grep -q "Device Tree Blob"; then
          echo "❌ DTB文件格式错误"
          exit 1
        fi

    - name: Clone Armbian build repository
      run: |
        git clone --depth=1 https://github.com/armbian/build.git
        cd build
        
        # 验证仓库完整性
        if [ ! -f compile.sh ]; then
          echo "❌ 仓库克隆不完整"
          exit 1
        fi

    - name: Fix permissions
      run: |
        sudo chown -R runner:runner ${{ github.workspace }}
        sudo chmod -R 755 ${{ github.workspace }}

    - name: Build Armbian image
      run: |
        cd build
        
        # 启用详细日志
        set -x
        
        # 尝试构建
        sudo ./compile.sh \
          BOARD="${{ env.BOARD }}" \
          BRANCH=current \
          RELEASE="${{ env.RELEASE }}" \
          KERNEL_ONLY=no \
          KERNEL_CONFIGURE=no \
          BUILD_DESKTOP=no \
          CLEAN_LEVEL="none" \
          USE_TORRENT=no \
          CUSTOM_DTB="../userpatches/dtb/${{ env.DTB_FILE }}" \
          KERNELBRANCH="tag:v${{ env.KERNEL_VERSION }}" \
          EXTRA_ARGUMENTS="USB_INIT=yes" || exit 1
        
        # 检查输出
        if [ ! -d "${{ env.OUTPUT_DIR }}" ]; then
          echo "❌ 输出目录未创建"
          exit 1
        fi

    - name: Verify build output
      run: |
        ls -laR ${{ env.OUTPUT_DIR }}
        if [ -z "$(ls -A ${{ env.OUTPUT_DIR }}/*.img 2>/dev/null)" ]; then
          echo "❌ 未找到镜像文件"
          exit 1
        fi

    - name: Upload artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Armbian_S905L3B_Image
        path: ${{ env.OUTPUT_DIR }}/*.img
        retention-days: 30

    - name: Upload error logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: Build_Error_Logs
        path: |
          ${{ github.workspace }}/build/output/logs
          ${{ github.workspace }}/build/config
        retention-days: 7
