name: Build Armbian for S905L3B

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      BOARD: "s905l3"
      RELEASE: "bullseye"
      KERNEL_VERSION: "6.1.147"
      DTB_URL: "https://raw.githubusercontent.com/ophub/amlogic-dtb/meson-gxl/meson-gxlx2-p295.dtb"
      DTB_FILE: "meson-gxlx2-p295.dtb"
      OUTPUT_DIR: "${{ github.workspace }}/build/output/images"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup build environment
      run: |
        sudo apt update -y
        sudo apt install -y \
          build-essential git libncurses5-dev libssl-dev \
          bc flex bison libelf-dev liblz4-tool whiptail \
          parted kmod debootstrap qemu-user-static \
          chroot dosfstools rsync u-boot-tools curl \
          wget xz-utils cpio \
          python3-dev python3-pip python3-setuptools \
          libpython3-dev libffi-dev libssl-dev \
          binfmt-support qemu-user-static \
          systemd-container u-boot-tools \
          device-tree-compiler

    - name: Download and prepare DTB
      run: |
        mkdir -p userpatches/dtb
        wget -O "userpatches/dtb/${{ env.DTB_FILE }}" "${{ env.DTB_URL }}"
        
        # 验证DTB文件
        if [ ! -f "userpatches/dtb/${{ env.DTB_FILE }}" ]; then
          echo "❌ DTB文件下载失败"
          exit 1
        fi
        
        # 检查DTB是否有效
        if ! dtc -I dtb -O dts "userpatches/dtb/${{ env.DTB_FILE }}" > /dev/null 2>&1; then
          echo "❌ 下载的DTB文件无效"
          exit 1
        fi
        echo "✅ DTB文件验证通过"

    - name: Clone Armbian build repository
      run: |
        git clone --depth=1 https://github.com/armbian/build.git
        cd build
        
        # 验证内核版本是否存在
        if ! git ls-remote --tags https://github.com/armbian/linux-armbian | grep "v${{ env.KERNEL_VERSION }}"; then
          echo "❌ 错误：内核版本 ${{ env.KERNEL_VERSION }} 不存在"
          exit 1
        fi
        echo "✅ 内核版本验证通过"

    - name: Fix permissions
      run: |
        sudo chown -R $USER:$USER ${{ github.workspace }}
        sudo chmod -R a+rw ${{ github.workspace }}

    - name: Build Armbian image
      run: |
        cd build
        
        # 设置编译环境变量
        export DEBIAN_FRONTEND=noninteractive
        export LANG=C.UTF-8
        
        # 启用详细日志
        export SHOW_LOG=yes
        export DEBUG_MODE=yes
        
        # 开始构建
        sudo ./compile.sh \
          BOARD="${{ env.BOARD }}" \
          BRANCH=current \
          RELEASE="${{ env.RELEASE }}" \
          KERNEL_ONLY=no \
          KERNEL_CONFIGURE=no \
          BUILD_DESKTOP=no \
          CLEAN_LEVEL="none" \
          USE_TORRENT=no \
          CUSTOM_DTB="../userpatches/dtb/${{ env.DTB_FILE }}" \
          KERNELBRANCH="tag:v${{ env.KERNEL_VERSION }}" \
          EXTRA_ARGUMENTS="USB_INIT=yes" \
          LOG_OUTPUT_FILE="${{ github.workspace }}/build.log"
        
        # 检查构建状态
        if [ $? -ne 0 ]; then
          echo "❌ 镜像构建失败"
          echo "=== 最后50行日志 ==="
          tail -n 50 "${{ github.workspace }}/build.log"
          exit 1
        fi

    - name: Verify build output
      run: |
        OUTPUT_DIR="${{ env.OUTPUT_DIR }}"
        
        if [ ! -d "$OUTPUT_DIR" ]; then
          echo "❌ 错误：输出目录不存在: $OUTPUT_DIR"
          exit 1
        fi
        
        if [ -z "$(ls -A $OUTPUT_DIR/*.img 2>/dev/null)" ]; then
          echo "❌ 错误：未找到镜像文件"
          echo "=== 构建日志 ==="
          cat "${{ github.workspace }}/build.log"
          exit 1
        fi
        
        echo "✅ 构建成功！生成的镜像:"
        ls -lh $OUTPUT_DIR/*.img

    - name: Upload artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Armbian_S905L3B_Image
        path: ${{ env.OUTPUT_DIR }}/*.img
        retention-days: 30

    - name: Upload build log
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: Build_Log
        path: ${{ github.workspace }}/build.log
