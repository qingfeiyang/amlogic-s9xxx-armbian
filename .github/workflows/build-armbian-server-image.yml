name: Build Armbian for S905L3B

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      BOARD: "s905l3"
      RELEASE: "bullseye"
      # 尝试更稳定的内核版本（6.1.55是S905L3常用兼容版本）
      KERNEL_VERSION: "6.1.55"
      DTB_PATH: "https://raw.githubusercontent.com/ophub/amlogic-dtb/meson-gxl/gxlx2_p295_1g.dtb"
      OUTPUT_DIR: "build/output/images"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: 扩展磁盘空间（解决资源不足）
      run: |
        # GitHub Actions默认磁盘可能不足，扩展临时空间
        df -h
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android  # 清理无用大文件
        df -h

    - name: 安装完整依赖（避免缺失）
      run: |
        sudo apt update -y
        # 增加Armbian官方推荐的完整依赖列表
        sudo apt install -y \
          build-essential git libncurses5-dev libssl-dev \
          bc flex bison libelf-dev liblz4-tool whiptail \
          parted kmod debootstrap qemu-user-static \
          chroot dosfstools rsync u-boot-tools curl \
          libfdt-dev libpython3-dev python3-distutils \
          device-tree-compiler  # 新增设备树编译工具

    - name: 验证并下载DTB（确保文件有效）
      run: |
        mkdir -p userpatches/dtb
        # 增加超时和重试机制
        wget --tries=3 --timeout=10 -O "userpatches/dtb/gxlx2_p295_1g.dtb" ${{ env.DTB_PATH }}
        # 验证DTB文件完整性（检查文件大小）
        if [ ! -f "userpatches/dtb/gxlx2_p295_1g.dtb" ] || [ $(stat -c%s "userpatches/dtb/gxlx2_p295_1g.dtb") -lt 1024 ]; then
          echo "错误：DTB文件下载失败或不完整"
          exit 1
        fi
        # 显示DTB文件信息（确认格式正确）
        fdtdump userpatches/dtb/gxlx2_p295_1g.dtb | head -5

    - name: 克隆Armbian仓库并验证内核版本
      run: |
        git clone --depth=1 https://github.com/armbian/build.git
        cd build
        # 更严格的内核版本验证（检查是否存在对应分支）
        KERNEL_TAG="v${{ env.KERNEL_VERSION }}"
        if ! git ls-remote --tags https://github.com/armbian/linux | grep -q "${KERNEL_TAG}$"; then
          echo "错误：内核版本 ${KERNEL_TAG} 不存在，请更换版本"
          exit 1
        fi
        echo "内核版本 ${KERNEL_TAG} 验证通过"

    - name: 编译Armbian（增加调试日志）
      run: |
        cd build
        # 增加--debug参数输出详细日志，同时保存到文件
        sudo ./compile.sh \
          BOARD=${{ env.BOARD }} \
          BRANCH=current \
          RELEASE=${{ env.RELEASE }} \
          KERNEL_ONLY=no \
          KERNEL_CONFIGURE=no \
          BUILD_DESKTOP=no \
          CLEAN_LEVEL="images" \
          USE_TORRENT=no \
          CUSTOM_DTB="../userpatches/dtb/gxlx2_p295_1g.dtb" \
          KERNELBRANCH="tag:v${{ env.KERNEL_VERSION }}" \
          EXTRA_ARGUMENTS="USB_INIT=yes" \
          --debug 2>&1 | tee build.log  # 保存日志到build.log

    - name: 上传编译日志（便于排查失败原因）
      if: always()  # 即使失败也上传日志
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: build/build.log

    - name: 验证并上传镜像
      run: |
        if [ -z "$(ls -A ${{ env.OUTPUT_DIR }}/*.img.xz 2>/dev/null)" ]; then
          echo "错误：未生成镜像文件"
          exit 1
        fi
        ls -lh ${{ env.OUTPUT_DIR }}/*.img.xz

    - name: 上传镜像
      uses: actions/upload-artifact@v4
      with:
        name: Armbian_S905L3B_Image
        path: ${{ env.OUTPUT_DIR }}/*.img.xz
        retention-days: 30
