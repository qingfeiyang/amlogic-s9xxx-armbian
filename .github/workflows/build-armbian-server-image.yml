name: Build Armbian for S905L3B

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      BOARD: "s905l3"
      RELEASE: "bullseye"
      KERNEL_VERSION: "6.1.147"
      DTB_URL: "https://raw.githubusercontent.com/ophub/amlogic-dtb/meson-gxl/meson-gxlx2-p295.dtb"
      DTB_FILE: "meson-gxlx2-p295.dtb"
      OUTPUT_DIR: "${{ github.workspace }}/armbian-build/output/images"

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup build environment
      run: |
        # æ·»åŠ å¿…è¦çš„è½¯ä»¶æº
        sudo add-apt-repository universe -y
        sudo add-apt-repository multiverse -y
        sudo apt update -y
        
        # ä¿®å¤ï¼šå½»åº•æ¸…é™¤æ‰€æœ‰å®¹å™¨ç›¸å…³åŒ…
        sudo apt purge -y containerd* docker* 
        sudo rm -rf /var/lib/docker /etc/docker
        sudo rm -f /etc/apparmor.d/docker
        sudo apt autoremove -y
        
        # ä¿®å¤ï¼šæ‰‹åŠ¨å®‰è£…containerd.ioé¿å…å†²çª
        wget https://download.docker.com/linux/ubuntu/dists/jammy/pool/stable/amd64/containerd.io_1.6.28-1_amd64.deb
        sudo dpkg -i containerd.io_1.6.28-1_amd64.deb
        
        # å®‰è£…å®Œæ•´çš„ä¾èµ–åŒ…ï¼ˆæ’é™¤å†²çªåŒ…ï¼‰
        sudo apt install -y \
          build-essential git libncurses5-dev libssl-dev \
          bc flex bison libelf-dev liblz4-tool whiptail \
          parted kmod debootstrap qemu-user-static \
          dosfstools rsync u-boot-tools curl \
          wget xz-utils cpio \
          python3-dev python3-pip python3-setuptools \
          libpython3-dev libffi-dev \
          binfmt-support \
          device-tree-compiler \
          coreutils debootstrap systemd \
          docker.io docker-compose
        
        # ä¿®å¤ï¼šé…ç½®dockeræ— éœ€containerd
        sudo mkdir -p /etc/docker
        echo '{"storage-driver": "vfs"}' | sudo tee /etc/docker/daemon.json
        
        # éªŒè¯å…³é”®å·¥å…·
        for cmd in chroot debootstrap dtc docker; do
          if ! command -v $cmd; then
            echo "âŒ $cmd æœªå®‰è£…æˆåŠŸ"
            exit 1
          fi
        done

    - name: Prepare workspace
      run: |
        # åˆ›å»ºå¹²å‡€çš„æ„å»ºç›®å½•ç»“æ„
        mkdir -p armbian-build/userpatches/dtb
        
        # ä¸‹è½½DTBæ–‡ä»¶
        wget -O "armbian-build/userpatches/dtb/${{ env.DTB_FILE }}" "${{ env.DTB_URL }}"
        
        # éªŒè¯DTBæ–‡ä»¶
        if ! file "armbian-build/userpatches/dtb/${{ env.DTB_FILE }}" | grep -q "Device Tree Blob"; then
          echo "âŒ DTBæ–‡ä»¶æ— æ•ˆ"
          exit 1
        fi
        echo "âœ… DTBæ–‡ä»¶éªŒè¯é€šè¿‡"

    - name: Clone Armbian build repository
      run: |
        cd armbian-build
        git clone --depth=1 https://github.com/armbian/build.git
        cd build
        
        # éªŒè¯ä»“åº“ç»“æ„
        if [ ! -f compile.sh ]; then
          echo "âŒ ä»“åº“å…‹éš†å¤±è´¥"
          exit 1
        fi
        echo "âœ… Armbianä»“åº“å…‹éš†æˆåŠŸ"

    - name: Run minimal build test
      run: |
        cd armbian-build/build
        
        # æ‰§è¡Œæœ€å°åŒ–æ„å»ºæµ‹è¯•
        sudo ./compile.sh \
          BOARD="${{ env.BOARD }}" \
          BRANCH=current \
          RELEASE="${{ env.RELEASE }}" \
          KERNEL_ONLY=yes \
          KERNEL_CONFIGURE=no \
          BUILD_MINIMAL=yes \
          CLEAN_LEVEL="none" \
          USE_TORRENT=no \
          CUSTOM_DTB="../../userpatches/dtb/${{ env.DTB_FILE }}" \
          KERNELBRANCH="tag:v${{ env.KERNEL_VERSION }}" \
          LOG_OUTPUT_FILE="$GITHUB_WORKSPACE/build.log"
        
        # æ£€æŸ¥é€€å‡ºçŠ¶æ€
        if [ $? -ne 0 ]; then
          echo "âŒ æœ€å°åŒ–æ„å»ºå¤±è´¥"
          echo "=== æ„å»ºæ—¥å¿—æœ€å50è¡Œ ==="
          tail -n 50 "$GITHUB_WORKSPACE/build.log" || echo "æ— æ—¥å¿—æ–‡ä»¶"
          exit 1
        fi
        echo "âœ… æœ€å°åŒ–æ„å»ºæµ‹è¯•é€šè¿‡"

    - name: Full build
      run: |
        cd armbian-build/build
        
        # æ‰§è¡Œå®Œæ•´æ„å»º
        sudo ./compile.sh \
          BOARD="${{ env.BOARD }}" \
          BRANCH=current \
          RELEASE="${{ env.RELEASE }}" \
          KERNEL_ONLY=no \
          KERNEL_CONFIGURE=no \
          BUILD_DESKTOP=no \
          CLEAN_LEVEL="none" \
          USE_TORRENT=no \
          CUSTOM_DTB="../../userpatches/dtb/${{ env.DTB_FILE }}" \
          KERNELBRANCH="tag:v${{ env.KERNEL_VERSION }}" \
          EXTRA_ARGUMENTS="USB_INIT=yes" \
          LOG_OUTPUT_FILE="$GITHUB_WORKSPACE/build.log"
        
        # æ£€æŸ¥æ„å»ºçŠ¶æ€
        if [ $? -ne 0 ]; then
          echo "âŒ å®Œæ•´æ„å»ºå¤±è´¥"
          echo "=== æ„å»ºæ—¥å¿—æœ€å50è¡Œ ==="
          tail -n 50 "$GITHUB_WORKSPACE/build.log"
          exit 1
        fi
        echo "âœ… å®Œæ•´æ„å»ºæˆåŠŸ"

    - name: Verify output
      run: |
        OUTPUT_DIR="${{ env.OUTPUT_DIR }}"
        
        # æ£€æŸ¥è¾“å‡ºç›®å½•
        if [ ! -d "$OUTPUT_DIR" ]; then
          echo "âŒ è¾“å‡ºç›®å½•ä¸å­˜åœ¨: $OUTPUT_DIR"
          exit 1
        fi
        
        # æ£€æŸ¥é•œåƒæ–‡ä»¶
        IMAGE_FILES=$(ls "$OUTPUT_DIR"/*.img 2>/dev/null)
        if [ -z "$IMAGE_FILES" ]; then
          echo "âŒ æœªæ‰¾åˆ°é•œåƒæ–‡ä»¶"
          echo "ç›®å½•å†…å®¹:"
          ls -la "$OUTPUT_DIR"
          exit 1
        fi
        
        # éªŒè¯é•œåƒæ–‡ä»¶
        for img in $IMAGE_FILES; do
          echo "ğŸ” éªŒè¯é•œåƒ: $(basename "$img")"
          if ! file "$img" | grep -q "DOS/MBR boot sector"; then
            echo "âŒ é•œåƒæ–‡ä»¶æ ¼å¼æ— æ•ˆ"
            exit 1
          fi
        done
        
        echo "âœ… é•œåƒéªŒè¯é€šè¿‡"
        echo "ç”Ÿæˆçš„é•œåƒ:"
        ls -lh "$OUTPUT_DIR"/*.img

    - name: Upload artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: Armbian_S905L3B_Image
        path: ${{ env.OUTPUT_DIR }}/*.img
        retention-days: 30

    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: Build_Failure_Logs
        path: |
          ${{ github.workspace }}/build.log
          ${{ github.workspace }}/armbian-build/build/output/logs
        retention-days: 7
