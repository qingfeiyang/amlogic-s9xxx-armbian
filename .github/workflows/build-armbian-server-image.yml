name: Build Armbian for S905L3B (USB Boot)

on:
  workflow_dispatch:  # 仅手动触发

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: 检查代码
      uses: actions/checkout@v4

    - name: 克隆 Armbian 构建仓库
      run: |
        git clone --depth=1 https://github.com/armbian/build.git
        cd build
        # 验证关键脚本存在
        if [ ! -f compile.sh ]; then
          echo "Armbian 仓库克隆失败"
          exit 1
        fi

    - name: 安装依赖
      run: |
        sudo apt update
        sudo apt install -y build-essential git libncurses5-dev libssl-dev \
          bc flex bison libelf-dev liblz4-tool whiptail parted kmod \
          debootstrap qemu-user-static chroot dosfstools rsync u-boot-tools

    - name: 编译 Armbian 镜像（S905L3 + U 盘启动）
      run: |
        cd build
        sudo ./compile.sh \
          BOARD=s905l3 \          # 芯片型号（S905L3 通用标识）
          BRANCH=current \        # 稳定分支
          RELEASE=bullseye \      # Debian 11（轻量稳定）
          KERNEL_ONLY=no \        # 编译完整镜像（含内核+根文件系统）
          BUILD_DESKTOP=no \      # 无桌面（节省资源，U 盘启动优先）
          CLEAN_LEVEL=images \    # 仅清理旧镜像（加速构建）
          USE_TORRENT=no \        # 禁用种子下载（加速）
          EXTRA_ARGUMENTS="USB_INIT=yes"  # 强制 U 盘启动初始化

    - name: 上传镜像
      uses: actions/upload-artifact@v4
      with:
        name: armbian-s905l3b-usb
        path: build/output/images/*.img.xz  # 压缩后的镜像（更小，便于下载）
        retention-days: 30  # 镜像保留 30 天
